<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: helpers/helpers.voxel.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: helpers/helpers.voxel.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import GeometriesVoxel from '../../src/geometries/geometries.voxel';
import ModelsStack     from '../../src/models/models.stack';
import ModelsVoxel     from '../../src/models/models.voxel';

/**
 * @module helpers/voxel
 */

export default class HelpersVoxel extends THREE.Object3D{
  constructor(worldCoordinates = null, stack = null) {
    super();

    this._stack = stack;
    this._worldCoordinates = worldCoordinates;

    this._voxel = new ModelsVoxel();
    this._voxel.id = this.id;
    this._voxel.worldCoordinates = this._worldCoordinates;

    // if stack provided, compute IJK and value
    if(this._stack &amp;&amp; this._stack.prepared &amp;&amp; this._worldCoordinates){
      this.updateVoxel(this._worldCoordinates);
    }

    // part of the helper...?
    this._mesh =  null;
    this._geometry = null;
    this._material = null;
    // 3 next purpose is just to change the color: at widget level
    this._selected =  false;
    this._active =  false;
    this._hover =  false;
    this._distance = null;

    this._showVoxel =  true;
    this._showDomSVG =  true;
    this._showDomMeasurements =  true;
    this._color = '#00B0FF';
    // just visualization
    // this._svgPointer = '&lt;svg width="40" height="40" \
    //      viewBox="0 0 140 140" version="1.1" \
    //      xmlns="http://www.w3.org/2000/svg"> \
    //   \
    //     &lt;polyline points="10,70 \
    //                       70,10 \
    //                       130,70" />\
    //   \
    //   &lt;/svg>';
    /*jshint multistr: true */
    this._svgPointer = '&lt;svg width="40" height="40" \
                      viewBox="0 0 140 140" version="1.1" \
                      xmlns="http://www.w3.org/2000/svg"> \
                      \
                      &lt;path d="M70,70 \
                               L30,30 \
                               A10,10 0 1 1 10,10\
                               A10,10 0 1 1 30,30" />\
                      \
                      &lt;/svg>'                        ;
                      

    this.createMesh();
  }

  updateVoxel(worldCoordinates) {
    // update world coordinates
    this._voxel.worldCoordinates = worldCoordinates;

    // update data coordinates
    this._voxel.dataCoordinates =  ModelsStack.worldToData(
                  this._stack,
                  this._voxel.worldCoordinates);

    // update value
    let value = ModelsStack.value(
      this._stack,
      this._voxel.dataCoordinates);

    this._voxel.value = ModelsStack.valueRescaleSlopeIntercept(
      value,
      this._stack.rescaleSlope,
      this._stack.rescaleIntercept);
  }

  updateVoxelScreenCoordinates(camera, container){
    this._voxel.screenCoordinates = HelpersVoxel.worldToScreen(
      this._worldCoordinates,
      camera,
      container);
  }
  
  createMesh() {

    let dataCoordinates = ModelsStack.worldToData(
      this._stack,
      this._worldCoordinates);

    this._geometry = new GeometriesVoxel(dataCoordinates);
    this._material = new THREE.MeshBasicMaterial({
        wireframe: true,
        wireframeLinewidth: 2
      });
    this._material.color.set(this._color);
    this._mesh = new THREE.Mesh(this._geometry, this._material);
    this._mesh.applyMatrix(this._stack.ijk2LPS);

    this._mesh.visible = this._showVoxel;

    this.add(this._mesh);
  }

  createDom() {
    // that could be a web-component!
    let measurementsContainer = this._createDiv('VJSVoxelMeasurements', this.id, 'VJSVoxelMeasurements');
    // RAS
    let rasContainer = this._createDiv('VJSVoxelProbeWorld', this.id, 'VJSVoxelProbeWorld');
    measurementsContainer.appendChild(rasContainer);
    // IJK
    let ijkContainer = this._createDiv('VJSVoxelProbeData', this.id, 'VJSVoxelProbeData');
    measurementsContainer.appendChild(ijkContainer);
    // Value
    let valueContainer = this._createDiv('VJSVoxelProbeValue', this.id, 'VJSVoxelProbeValue');
    measurementsContainer.appendChild(valueContainer);

    // SVG
    let svgContainer = this._createDiv('VJSVoxelProbeSVG', this.id, 'VJSVoxelProbeSVG');
    svgContainer.innerHTML = this._svgPointer;

    // Package everything
    let domElement = this._createDiv('VJSWidgetVoxelProbe', this.id, 'VJSWidgetVoxelProbe');
    domElement.appendChild(svgContainer);
    domElement.appendChild(measurementsContainer);

    return domElement;
  }

  updateDom(container) {

    if (document.getElementById('VJSVoxelProbeWorld' + this.id) === null) {
      container.appendChild(this.createDom());
    }

    // update content
    let rasContainer = document.getElementById('VJSVoxelProbeWorld' + this.id);
    let rasContent = this._voxel.worldCoordinates.x.toFixed(2) + ' : ' +
                     this._voxel.worldCoordinates.y.toFixed(2) + ' : ' +
                     this._voxel.worldCoordinates.z.toFixed(2);
    rasContainer.innerHTML = 'LPS: ' + rasContent;

    let ijkContainer = document.getElementById('VJSVoxelProbeData' + this.id);
    let ijkContent = this._voxel.dataCoordinates.x + ' : ' +
                     this._voxel.dataCoordinates.y + ' : ' +
                     this._voxel.dataCoordinates.z;
    ijkContainer.innerHTML = 'IJK: ' + ijkContent;

    let valueContainer = document.getElementById('VJSVoxelProbeValue' + this.id);
    let valueContent = this._voxel.value;
    valueContainer.innerHTML = 'Value: ' + valueContent;

    // update div position
    let selectedElement = document.getElementById('VJSWidgetVoxelProbe' + this.id);
    selectedElement.style.top = this._voxel.screenCoordinates.y;
    selectedElement.style.left = this._voxel.screenCoordinates.x;
    // window.console.log(this._voxel);
    // selectedElement.style['transform-origin'] = 'top left';
    // selectedElement.style['transform'] = 'translate(' + this._voxel.screenCoordinates.x + 'px, ' + this._voxel.screenCoordinates.y + 'px)';

    this.updateDomClass(selectedElement);
  }

  updateDomClass() {
    let element = document.getElementById('VJSWidgetVoxelProbe' + this.id);
    if (this._active === true) {
      element.classList.add('VJSVoxelProbeActive');
    } else {
      element.classList.remove('VJSVoxelProbeActive');
    }

    if (this._hover === true) {
      element.classList.add('VJSVoxelProbeHover');
    } else {
      element.classList.remove('VJSVoxelProbeHover');
    }

    if (this._selected === true) {
      element.classList.add('VJSVoxelProbeSelect');
    } else {
      element.classList.remove('VJSVoxelProbeSelect');
    }

    this.updateDomElementDisplay('VJSVoxelMeasurements' + this.id, this._showDomMeasurements);
    this.updateDomElementDisplay('VJSVoxelProbeSVG' + this.id, this._showDomSVG);
  }

  updateDomElementDisplay(id, show) {
    if (show) {
      document.getElementById(id).style.display = 'block';
    } else {
      document.getElementById(id).style.display = 'none';
    }
  }

  removeTest() {
    // remove voxelDom
    let node = document.getElementById('VJSWidgetVoxelProbe' + this.id);
    if (node.parentNode) {
      node.parentNode.removeChild(node);
    }

    // remove voxelMesh
    this.remove(this._mesh);
    this._mesh.geometry.dispose();
    this._mesh.material.dispose();
    this._mesh = null;
  }

  static worldToScreen(worldCoordinate, camera, canvas) {
    let screenCoordinates = worldCoordinate.clone();
    screenCoordinates.project(camera);

    screenCoordinates.x = Math.round((screenCoordinates.x + 1) * canvas.offsetWidth / 2);
    screenCoordinates.y = Math.round((-screenCoordinates.y + 1) * canvas.offsetHeight / 2);
    screenCoordinates.z = 0;

    return screenCoordinates;
  }

  _createDiv(idPrefix, idSuffix, className) {
    let divContainer = document.createElement('div');
    divContainer.setAttribute('id', idPrefix + idSuffix);
    divContainer.setAttribute('class', className);

    return divContainer;
  }
  
  set color(color) {
    this._color = color;
    if (this._material) {
      this._material.color.set(this._color);
    }

    // also update the dom
    let selectedElement = document.getElementById('VJSVoxelMeasurements' + this.id);
    if(selectedElement){
      selectedElement.style.borderColor = this._color.replace( '0x','#' );
    }
    
    selectedElement = document.querySelector('#VJSVoxelProbeSVG' + this.id + '> svg > path');
    if(selectedElement){
      selectedElement.style.stroke = this._color.replace( '0x','#' );
    }
  }

  get color() {
    return this._color;
  }

  set worldCoordinates(worldCoordinates){
    this._worldCoordinates = worldCoordinates;
    this._voxel._worldCoordinates = worldCoordinates;

    // set data coordinates &amp;&amp; value
    this.updateVoxel(this._worldCoordinates);

    if(this._mesh &amp;&amp; this._mesh.geometry){
      this._mesh.geometry.location = this._voxel.dataCoordinates;
    }
  }

  get worldCoordinates(){
    return this._worldCoordinates;
  }

  get voxel(){
    return this._voxel;
  }

  set voxel(voxel){
    this._voxel = voxel;
  }

  set showVoxel(showVoxel){
    this._showVoxel = showVoxel;

    if(this._mesh){
      this._mesh.visible = this._showVoxel;
    }
  }
  get showVoxel(){
    return this._showVoxel;
  }

  set showDomSVG(showDomSVG){
    this._showDomSVG = showDomSVG;
    this.updateDomClass();
  }
  get showDomSVG(){
    return this._showDomSVG;
  }

  set showDomMeasurements(showDomMeasurements){
    this._showDomMeasurements = showDomMeasurements;
    this.updateDomClass();
  }
  get showDomMeasurements(){
    return this._showDomMeasurements;
  }

  set distance(distance){
    this._distance = distance;
  }

  get distance(){
    return this._distance;
  }

  set selected(selected){
    this._selected = selected;
  }

  get selected(){
    return this._selected;
  }

  set hover(hover){
    this._hover = hover;
  }

  get hover(){
    return this._hover;
  }

  set active(active){
    this._active = active;
  }

  get active(){
    return this._active;
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-cameras.html">cameras</a></li><li><a href="module-cameras_orthographic.html">cameras/orthographic</a></li><li><a href="module-core.html">core</a></li><li><a href="module-core_intersections.html">core/intersections</a></li><li><a href="module-core_pack.html">core/pack</a></li><li><a href="module-core_utils.html">core/utils</a></li><li><a href="module-core_validators.html">core/validators</a></li><li><a href="module-geometries.html">geometries</a></li><li><a href="module-geometries_slice.html">geometries/slice</a></li><li><a href="module-geometries_voxel.html">geometries/voxel</a></li><li><a href="module-helpers.html">helpers</a></li><li><a href="module-helpers_border.html">helpers/border</a></li><li><a href="module-helpers_boundingbox.html">helpers/boundingbox</a></li><li><a href="module-helpers_dummy.html">helpers/dummy</a></li><li><a href="module-helpers_lut.html">helpers/lut</a></li><li><a href="module-helpers_material_mixin.html">helpers/material/mixin</a></li><li><a href="module-helpers_progressBar.html">helpers/progressBar</a></li><li><a href="module-helpers_slice.html">helpers/slice</a></li><li><a href="module-helpers_stack.html">helpers/stack</a></li><li><a href="module-helpers_volumerendering.html">helpers/volumerendering</a></li><li><a href="module-helpers_voxel.html">helpers/voxel</a></li><li><a href="module-loaders.html">loaders</a></li><li><a href="module-loaders_base.html">loaders/base</a></li><li><a href="module-loaders_volumes.html">loaders/volumes</a></li><li><a href="module-models.html">models</a></li><li><a href="module-models_base.html">models/base</a></li><li><a href="module-models_frame.html">models/frame</a></li><li><a href="module-models_series.html">models/series</a></li><li><a href="module-models_stack.html">models/stack</a></li><li><a href="module-models_voxel.html">models/voxel</a></li><li><a href="module-parsers.html">parsers</a></li><li><a href="module-parsers_dicom.html">parsers/dicom</a></li><li><a href="module-parsers_nifti.html">parsers/nifti</a></li><li><a href="module-parsers_volume.html">parsers/volume</a></li><li><a href="module-shaders.html">shaders</a></li><li><a href="module-shaders_data.html">shaders/data</a></li><li><a href="module-widgets.html">widgets</a></li><li><a href="module-widgets_handle.html">widgets/handle</a></li><li><a href="module-widgets_squareProbe.html">widgets/squareProbe</a></li><li><a href="module-widgets_voxelProbe.html">widgets/voxelProbe</a></li></ul><h3>Classes</h3><ul><li><a href="module.exports.html">exports</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.0-dev</a> on Wed Nov 16 2016 09:44:56 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
